<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.7.0"/><meta data-react-helmet="true" name="description" content="Peter Fisher is a UK based PHP contractor, a coding teacher and podcast host at How To Code Well"/><meta data-react-helmet="true" property="og:title" content="Install Jenkins with terraform and ansible on a Linode VPS"/><meta data-react-helmet="true" property="og:description" content="Peter Fisher is a UK based PHP contractor, a coding teacher and podcast host at How To Code Well"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@pfwd"/><meta data-react-helmet="true" name="twitter:title" content="Install Jenkins with terraform and ansible on a Linode VPS"/><meta data-react-helmet="true" name="twitter:description" content="Peter Fisher is a UK based PHP contractor, a coding teacher and podcast host at How To Code Well"/><meta name="theme-color" content="#663399"/><style data-href="/styles.adfd0ed60e141b1d8732.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.header-module--header--666b3{background:#555;padding:1rem}.header-module--inner-container--2f178{align-items:center;display:flex;margin:0 auto;padding:.45rem 1.0875rem;width:960px}.header-module--inner-container--2f178 nav{display:flex;margin-left:auto}.header-module--inner-container--2f178 nav ul{display:flex;flex-direction:row}.header-module--inner-container--2f178 nav li{display:block;flex:auto;list-style:none;margin:0 .2rem;text-align:center}.header-module--inner-container--2f178 nav a{background-color:#e7d8d8;color:#333;font-weight:700;padding:.5rem;text-decoration:none}.header-module--inner-container--2f178 nav a:hover{background-color:#1c1a1a;color:#f2923c}.header-module--brand-link--8f262{display:inline-block;line-height:3rem;margin:0}.header-module--brand-link--8f262 a{color:#e7d8d8;text-decoration:none}.header-module--brand-link--8f262 a:hover{color:#e7d8d8;text-decoration:underline}.header-module--menu--4f3a7{display:flex;justify-content:space-around}.header-module--menu--4f3a7 ul{display:flex;list-style:none;margin:0;padding:0}@media (max-width:480px){.header-module--inner-container--2f178{display:block;padding:0;width:100%}.header-module--inner-container--2f178 .header-module--brand-link--8f262{margin-bottom:1rem;margin-top:1rem;padding:0;text-align:center;width:100%}nav{margin-bottom:1rem}}@media (max-width:736px){.header-module--brand-link--8f262{width:30%}html{font-size:12px}}.footer-module--footer--a2fe4{background:#555;margin-top:auto;padding:1rem;width:100%}.footer-module--inner-container--eaeed{display:flex;margin:0 auto;width:960px}.footer-module--inner-container--eaeed nav li{list-style:none;padding:.45rem}.footer-module--inner-container--eaeed nav a{background-color:#fff;border-radius:6px;color:#333;font-weight:700;padding:20px;text-decoration:none}.footer-module--inner-container--eaeed nav a:hover{background-color:#f2923c;color:#fff}.footer-module--brand-link--ed786{color:#fff;line-height:2em;text-decoration:none}.footer-module--social-container--9bb94{margin:auto}.footer-module--social-container--9bb94 ul{display:flex;list-style:none;margin:5px 0;padding:0}.footer-module--social-container--9bb94 ul li{line-height:0;margin:0 10px}.footer-module--social-container--9bb94 a.footer-module--icon--15b02{background-repeat:no-repeat;color:#fff}.footer-module--social-container--9bb94 i{color:#ddd;margin-right:10px}@media (max-width:480px){.footer-module--inner-container--eaeed{width:100%}.footer-module--footer--a2fe4{width:auto}.footer-module--hide-mobile--7cb50{display:none}}body{background-color:#1c1a1a;color:#e7d8d8;font-family:Open Sans,Arial,serif;font-size:1.4rem;line-height:2rem;margin:0}h1{font-size:2rem}h2{font-size:1.8rem}.site{display:flex;flex-direction:column;min-height:100vh}a{color:#f2923c;text-decoration:underline}a:hover{color:#e7d8d8}.container{margin:0 auto;width:960px}.iframeContainer{text-align:center}.iframe{max-height:314px;max-width:560px}.talkIframe{background:padding-box padding-box rgba(0,0,0,.1);border:0;border-radius:6px;box-shadow:0 5px 40px rgba(0,0,0,.2);margin:0;padding:0}.talk-title{margin-bottom:0}.talk-info-container{margin-bottom:1rem}.talk-info-container h2{margin-bottom:.5rem}.contentContainer{padding-bottom:2rem;padding-top:2rem}.talk-info{color:#888;font-size:1.3rem}@media (max-width:480px){.container{width:100%}.contentContainer{padding:2rem}html{font-size:12px}}@media (max-width:736px){.container{width:100%}html{font-size:12px}}@media (min-width:768px){html{font-size:14px}.iframe{height:314px;width:560px}.iframeContainer{text-align:left}}@media (min-width:992px){html{font-size:15px}}@media (min-width:1200px){html{font-size:16px}}.site-module--hero--b1146{border-bottom:1px solid #ddd;font-size:1.8rem;line-height:2.2rem;padding-bottom:40px}.site-module--hero--b1146 p{margin:0}.site-module--hero--b1146 a{color:#f2923c;padding:5px;text-decoration:none}.site-module--hero--b1146 a:hover{background-color:#f2923c;color:#fff}.site-module--about_me--959f9 h3{margin-bottom:10px}.site-module--about_me--959f9 p,.site-module--summary--042a9 p{margin:0;padding:0}.site-module--summary--042a9{align-items:center;display:flex;font-size:1.4rem;justify-content:space-around;justify-items:center;line-height:2rem;margin-bottom:40px;margin-top:40px}.site-module--summary--042a9 img{border-radius:20px;display:block;margin-right:1rem;width:50%}.site-module--about_me--959f9 img{border-radius:20px;display:block;margin-right:1rem;width:25%}.site-module--button-row--8cf94{border-top:1px solid #ddd;margin-top:20px;padding-top:50px}.site-module--hero-box--51789,.site-module--hero-box-highlight--82aee{background-color:#ddd;border:1px solid #ddd;font-weight:700;padding:20px}.site-module--hero-box-highlight--82aee{background-color:#f2923c;color:#f2923c}a.site-module--hero-box--51789{border-radius:20px;color:#000}a.site-module--hero-box--51789:hover{color:#fff;cursor:pointer}a.site-module--hero-box-highlight--82aee:hover{cursor:pointer}a.site-module--hero-box-highlight--82aee{background-color:#fff;border:2px solid #f2923c;border-radius:20px;color:#000;cursor:pointer;display:block;position:relative;transition:all .4s cubic-bezier(.215,.61,.355,1) 0s}a.site-module--hero-box-highlight--82aee:hover{background-color:transparent;color:#000!important;text-shadow:nthree}a.site-module--hero-box-highlight--82aee:hover:before{left:0;right:auto;width:100%}a.site-module--hero-box-highlight--82aee:before{background:#f2923c;border-radius:15px;color:#000!important;content:"";display:block;height:100%;position:absolute;right:0;top:0;transition:all .4s cubic-bezier(.215,.61,.355,1) 0s;width:0;z-index:-1}</style><title data-react-helmet="true">Install Jenkins with terraform and ansible on a Linode VPS | Peter Fisher</title><link data-react-helmet="true" rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous"/><link rel="icon" href="/favicon-32x32.png?v=ff206ddbe85848707b0153ebe3236a1b" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=ff206ddbe85848707b0153ebe3236a1b"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=ff206ddbe85848707b0153ebe3236a1b"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="site"><header class="header-module--header--666b3"><div class="header-module--inner-container--2f178"><h1 class="header-module--brand-link--8f262"><a href="/">Peter Fisher</a></h1><nav role="navigation" class="header-module--menu--4f3a7"><ul class="header-module--menu--4f3a7"><li><a href="/">About</a></li><li><a href="/blog/">Blog</a></li><li><a href="/talks/">Talks</a></li><li><a to="https://howtocodewell.net" href="https://howtocodewell.net" target="_blank" rel="noopener noreferrer">How To Code Well</a></li></ul></nav></div></header><div class="container"><div class="contentContainer"><h1>Install Jenkins with terraform and ansible on a Linode VPS</h1><div class="post-body"><p>In this guide Jenkins will be installed on a Linode VPS using Terraform and Ansible.</p>
<p>Terraform will be used to provision the Linode VPS and Ansible will be used to install Jenkins and configure a firewall. This guide won't explain how to configure Jenkins once it is installed.</p>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#ignore-files-from-git">Ignore files from Git</a></li>
<li><a href="#create-a-vault-password">Create a vault password</a></li>
<li><a href="#create-a-linode-vps-with-terraform">Create a Linode VPS with Terraform</a>
<ul>
<li><a href="#create-terraform-inputs">Create Terraform inputs</a></li>
<li><a href="#create-terraform-outputs">Create Terraform outputs</a></li>
<li><a href="#create-a-template-for-the-ansible-hosts">Create a template for the Ansible hosts</a></li>
<li><a href="#create-terraform-main">Create Terraform main</a></li>
<li><a href="#create-the-inputs-for-the-site-module">Create the inputs for the site module</a></li>
<li><a href="#create-the-local-variables-for-the-site-module">Create the local variables for the site module</a></li>
<li><a href="#create-the-main-file-for-the-site-module">Create the main file for the site module</a></li>
<li><a href="#create-the-output-file-for-the-site-module">Create the output file for the site module</a></li>
<li><a href="#provision-the-linode-vps">Provision the Linode VPS</a></li>
</ul>
</li>
<li><a href="#install-software-with-ansible">Install software with Ansible</a>
<ul>
<li><a href="#create-an-update-ansible-role">Create an update Ansible role</a></li>
<li><a href="#create-a-firewall-ansible-role">Create a firewall Ansible role</a></li>
<li><a href="#run-the-ansible-playbook">Run the Ansible playbook</a></li>
</ul>
</li>
</ul>
<h2>Setup</h2>
<p>This guide assumes the following things:</p>
<ul>
<li>Ansible is installed locally</li>
<li>Jenkins is installed locally</li>
<li>You have a Linode account</li>
<li>You have a Linode access token</li>
<li>You have a SSH key</li>
</ul>
<p>The first thing to do is to create the following folder structure.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ansible/
└───roles/
    └───jenkins/
        └───tasks/
    └───firewall/
        └───tasks/
    └───upgrade/
        └───tasks/
terraform/
└───modules/
    └───site/
└───templates/</code></pre></div>
<h2>Ignore files from Git</h2>
<p>Create a <code class="language-text">.gitignore</code> file in the root directory with the following</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># IDE</span>
.idea

<span class="token comment"># Ansible</span>
ansible/hosts
ansible/.vault_pass.txt

<span class="token comment"># Terraform</span>
terraform/.terraform.lock.hcl
terraform/.terraform
terraform/terraform.tfvars
terraform/terraform.tfstate
terraform/.terraform.tfstate.lock.info
terraform/terraform.tfstate.backup</code></pre></div>
<h2>Create a vault password</h2>
<p>Create the file <code class="language-text">ansible/.vault_pass.txt</code> with a random vault password.  This will be used later in the Ansible steps.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">SomeRandomString</code></pre></div>
<h2>Create a Linode VPS with Terraform</h2>
<p>Create the file <code class="language-text">terraform/terraform.tfvars</code> and add the following variables</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token string">"&lt;YOUR_LINODE_TOKEN>"</span>
<span class="token assign-left variable">root_pass</span><span class="token operator">=</span><span class="token string">"&lt;YOUR_LINODE_ROOT_PASSWORD"</span>
<span class="token assign-left variable">ssh_key_pub</span><span class="token operator">=</span><span class="token string">"&lt;PATH_TO_YOUR_SSH_KEY>"</span></code></pre></div>
<h3>Create Terraform inputs</h3>
<p>Create the file <code class="language-text">terraform/inputs.tf</code> and add the following inputs</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">variable <span class="token string">"token"</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">type</span> <span class="token operator">=</span> string
  description <span class="token operator">=</span> <span class="token string">"Environment in which to deploy application"</span>
  sensitive <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
variable <span class="token string">"root_pass"</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">type</span> <span class="token operator">=</span> string
  description <span class="token operator">=</span> <span class="token string">"Site Root Password"</span>
  sensitive <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

variable <span class="token string">"ssh_key_pub"</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">type</span> <span class="token operator">=</span> string
  description <span class="token operator">=</span> <span class="token string">"SSH KEY"</span>
  sensitive <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>Create Terraform outputs</h3>
<p>Create the file <code class="language-text">terraform/outputs.tf</code> with the following output variables</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">output <span class="token string">"webserver_id"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> module.site.jenkins-site-id
<span class="token punctuation">}</span>
output <span class="token string">"webserver_ip"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> module.site.jenkins-site-public-ip
<span class="token punctuation">}</span>
output <span class="token string">"webserver_private_ip"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> module.site.jenkins-site-private-ip
<span class="token punctuation">}</span></code></pre></div>
<h3>Create a template for the Ansible hosts</h3>
<p>Create a file in <code class="language-text">terraform/templats/hosts.tpl</code> with the following template</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">all:
  children:
    webservers:
      hosts:
        webserver_1:
          ansible_host: ${webserver_ip}
          private_ip: ${webserver_private_ip}</code></pre></div>
<h3>Create Terraform main</h3>
<p>Create the file <code class="language-text">terraform/main.tf</code> and add the following Terraform code</p>
<p>This will do the following:</p>
<ul>
<li>Install the Linode provider using version <code class="language-text">1.18.0</code></li>
<li>Pass the Linode token to the Linode provider</li>
<li>Require the <code class="language-text">site</code> module and provide it the <code class="language-text">root_pass</code> and <code class="language-text">ssh_key_pub</code> variables</li>
<li>Create a file in the <code class="language-text">ansible</code> directory with jenkins private and public IPs</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform <span class="token punctuation">{</span>
  required_providers <span class="token punctuation">{</span>
    linode <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">"linode/linode"</span>
      version <span class="token operator">=</span> <span class="token string">"1.18.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

provider <span class="token string">"linode"</span> <span class="token punctuation">{</span>
  token <span class="token operator">=</span> var.token
<span class="token punctuation">}</span>

module <span class="token string">"site"</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">"./modules/site"</span>
  root_pass <span class="token operator">=</span> var.root_pass
  ssh_key_pub <span class="token operator">=</span> var.ssh_key_pub
  label <span class="token operator">=</span> <span class="token string">"jenkins"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"local_file"</span> <span class="token string">"hosts"</span> <span class="token punctuation">{</span>
  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    module.site
  <span class="token punctuation">]</span>
  content <span class="token operator">=</span> templatefile<span class="token punctuation">(</span><span class="token string">"./templates/hosts.tpl"</span>,
    <span class="token punctuation">{</span>
      webserver_ip <span class="token operator">=</span> module.site.jenkins-site-public-ip
      webserver_private_ip <span class="token operator">=</span> module.site.jenkins-site-private-ip
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  filename <span class="token operator">=</span> <span class="token string">"../ansible/hosts"</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>Create the inputs for the site module</h3>
<p>Create the file <code class="language-text">terraform/modules/site/inputs.tf</code> and add the following terraform code</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">variable <span class="token string">"root_pass"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

variable <span class="token string">"ssh_key_pub"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

variable <span class="token string">"label"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></div>
<h3>Create the local variables for the site module</h3>
<p>Create the file <code class="language-text">terraform/modules/site/locals.tf</code> and add the following terraform code</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">locals <span class="token punctuation">{</span>
  region <span class="token operator">=</span> <span class="token string">"eu-west"</span>
  site_label <span class="token operator">=</span> <span class="token string">"jenkinsSite"</span>
  site_type <span class="token operator">=</span> <span class="token string">"g6-nanode-1"</span>
  image <span class="token operator">=</span> <span class="token string">"linode/ubuntu18.04"</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>Create the main file for the site module</h3>
<p>Create the file <code class="language-text">terraform/modules/site/main.tf</code> with the following terraform code.</p>
<p>This will do the following:</p>
<ul>
<li>Use the linode provider</li>
<li>Create a <code class="language-text">linode_sshkey</code> resource</li>
<li>Create a <code class="language-text">lindoe_instance</code> resource</li>
<li>Upgrade the VPS and install Python</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform <span class="token punctuation">{</span>
  required_providers <span class="token punctuation">{</span>
    linode <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">"linode/linode"</span>
      version <span class="token operator">=</span> <span class="token string">"1.18.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

resource <span class="token string">"linode_sshkey"</span> <span class="token string">"jenkins"</span> <span class="token punctuation">{</span>
  label <span class="token operator">=</span> var.label
  ssh_key <span class="token operator">=</span> chomp<span class="token punctuation">(</span>file<span class="token punctuation">(</span>var.ssh_key_pub<span class="token punctuation">))</span>
<span class="token punctuation">}</span>

resource <span class="token string">"linode_instance"</span> <span class="token string">"jenkins"</span> <span class="token punctuation">{</span>
  label <span class="token operator">=</span> var.label
  group <span class="token operator">=</span> local.site_label
  image <span class="token operator">=</span> local.image
  region <span class="token operator">=</span> local.region
  <span class="token builtin class-name">type</span> <span class="token operator">=</span> local.site_type
  private_ip <span class="token operator">=</span> <span class="token boolean">true</span>
  root_pass <span class="token operator">=</span> var.root_pass
  authorized_keys <span class="token operator">=</span> <span class="token punctuation">[</span>
    linode_sshkey.jenkins.ssh_key
  <span class="token punctuation">]</span>

  provisioner <span class="token string">"remote-exec"</span> <span class="token punctuation">{</span>
    inline <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">"sudo apt-get update &amp;&amp; sudo apt-get upgrade -y"</span>,
      <span class="token string">"sudo apt-get -qq upgrade -y"</span>,
      <span class="token string">"sudo apt-get -qq install python -y"</span>,
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div>
<h3>Create the output file for the site module</h3>
<p>Create the file <code class="language-text">terraform/modules/site/outputs.tf</code> with the following terraform code.</p>
<p>This will do the following:</p>
<ul>
<li>Output the VPS ID</li>
<li>Output the public IP address</li>
<li>Output the Private IP address</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">output <span class="token string">"jenkins-site-id"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> linode_instance.jenkins.id
<span class="token punctuation">}</span>
output <span class="token string">"jenkins-site-public-ip"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> linode_instance.jenkins.ip_address
<span class="token punctuation">}</span>
output <span class="token string">"jenkins-site-private-ip"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> linode_instance.jenkins.private_ip_address
<span class="token punctuation">}</span></code></pre></div>
<h3>Provision the Linode VPS</h3>
<p>In a terminal run the following inside the <code class="language-text">terraform</code> folder</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ terraform init</code></pre></div>
<p>Then apply the terraform plan</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ terraform apply</code></pre></div>
<p>Once the VPS is provisioned the output variables should be shown in the terminsal like so</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">Apply complete<span class="token operator">!</span> Resources: <span class="token number">3</span> added, <span class="token number">0</span> changed, <span class="token number">0</span> destroyed.

Outputs:

webserver_id <span class="token operator">=</span> <span class="token string">"&lt;VPS_ID>"</span>
webserver_ip <span class="token operator">=</span> <span class="token string">"&lt;VPS_PUBLIC_IP>"</span>
webserver_private_ip <span class="token operator">=</span> <span class="token string">"&lt;VPS_PRIVATE_IP>"</span></code></pre></div>
<p>There should also be a <code class="language-text">hosts</code> file in the <code class="language-text">ansible</code> directory with the populated IP addresses.  It should look similar to the following</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">all:
  children:
    webservers:
      hosts:
        webserver_1:
          ansible_host: &lt;VPS_PUBLIC_IP>
          private_ip: &lt;VPS_PRIVATE_IP></code></pre></div>
<h2>Install software with Ansible</h2>
<p>Create the file <code class="language-text">ansible/ansible.cfg</code> that will hold the Ansible configuration</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[defaults]
inventory = hosts
host_key_checking = false
vault_password_file = .vault_pass.txt</code></pre></div>
<h3>Create an update Ansible role</h3>
<p>Create the file <code class="language-text">ansible/roles/upgrade/tasks/main.yml</code> with the following yaml code which will update the package cache on the Linode VPS</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Update and upgrade apt packages
  <span class="token key atrule">become</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">apt</span><span class="token punctuation">:</span>
    <span class="token key atrule">upgrade</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">cache_valid_time</span><span class="token punctuation">:</span> <span class="token number">86400</span></code></pre></div>
<h3>Create a firewall Ansible role</h3>
<p>Create the file <code class="language-text">ansible/roles/firewall/tasks/main.yml</code> with the following yaml code which will use <code class="language-text">ufw</code> to lock down the webserver.</p>
<p>This will do the following:</p>
<ul>
<li>Allow SSH on port 22</li>
<li>Allow HTTP requests on port 80</li>
<li>Allow HTTPS requests on port 443</li>
<li>Set the default policy to deny</li>
<li>Enable firewall logging</li>
</ul>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Allow SSH
  <span class="token key atrule">ufw</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> allow
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"22"</span>
    <span class="token key atrule">proto</span><span class="token punctuation">:</span> tcp

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Allow Port 80
  <span class="token key atrule">ufw</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> allow
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"80"</span>
    <span class="token key atrule">proto</span><span class="token punctuation">:</span> tcp

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Allow Port 443
  <span class="token key atrule">ufw</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> allow
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">proto</span><span class="token punctuation">:</span> tcp

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set firewall default policy
  <span class="token key atrule">ufw</span><span class="token punctuation">:</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> enabled
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> deny

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set logging
  <span class="token key atrule">ufw</span><span class="token punctuation">:</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span> on</code></pre></div>
<h3>Run the Ansible playbook</h3>
<p>To run the playbook, move into the <code class="language-text">ansible</code> directory and run the following command.</p>
<p><strong>Command arguments</strong></p>
<ul>
<li><code class="language-text">-i</code> = host inventory file.  This has automatically been created by Terraform</li>
<li><code class="language-text">-u</code> = The user that will run the commands</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ ansible-playbook <span class="token parameter variable">-i</span> ./hosts playbook.yaml <span class="token parameter variable">-u</span> root</code></pre></div></div><div class="site-module--about_me--959f9"><div class="site-module--summary--042a9"><img alt="Peter Fisher Contract Web Developer" src="https://1.gravatar.com/avatar/74ae5c84e2bfdccfbbe56ea0bd556af5?s=96&amp;r=g"/><p>Peter Fisher is a UK based PHP contractor with<!-- --> <strong>20 years experience in web development</strong> He can be hired to work with <strong>PHP</strong> using <strong>Symfony</strong> <!-- -->or <strong>Laravel</strong> or <strong>Flask</strong> and<!-- --> <strong>Django</strong> with <strong>Python</strong>.</p></div></div></div></div><footer class="footer-module--footer--a2fe4"><div class="footer-module--inner-container--eaeed"><div class="footer-module--social-container--9bb94"><ul><li><a href="https://twitter.com/pfwd" target="_blank" rel="noopener noreferrer" class="footer-module--icon--15b02"><i class="fab fa-twitter"></i></a></li><li><a href="https://github.com/pfwd" target="_blank" rel="noopener noreferrer" class="footer-module--icon--15b02"><i class="fab fa-github"></i></a></li><li><a href="https://www.linkedin.com/in/peterrfisher" rel="noopener noreferrer" target="_blank" class="footer-module--icon--15b02"><i class="fab fa-linkedin"></i></a></li><li><a href="https://www.youtube.com/howtocodewell" rel="noopener noreferrer" target="_blank" class="footer-module--icon--15b02"><i class="fab fa-youtube"></i></a></li></ul></div></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/talks/install-jenkins-with-terraform-and-ansible-on-linode-vps/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-a3cc052413a8bbaf1262.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-7aa9fa31dbc106c5d785.js\"],\"component---src-pages-blog-index-tsx\":[\"/component---src-pages-blog-index-tsx-0b2f526b617f4f6872bb.js\"],\"component---src-pages-blog-markdown-remark-frontmatter-slug-tsx\":[\"/component---src-pages-blog-markdown-remark-frontmatter-slug-tsx-acc7060580229c5888b4.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-151dcdd13f6f32301656.js\"],\"component---src-pages-slides-index-tsx\":[\"/component---src-pages-slides-index-tsx-cd4da2c90f09d4bd1818.js\"],\"component---src-pages-talks-index-tsx\":[\"/component---src-pages-talks-index-tsx-6d65219d63af6ea80b6f.js\"],\"component---src-pages-talks-markdown-remark-frontmatter-slug-tsx\":[\"/component---src-pages-talks-markdown-remark-frontmatter-slug-tsx-7f5307eca27730e92b40.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="9bc5e9a7b32f50d216ee";</script><script src="/webpack-runtime-e64adbd4f2c806c261f0.js" async></script><script src="/framework-0c5d232d3671b4e41248.js" async></script><script src="/app-a3cc052413a8bbaf1262.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>